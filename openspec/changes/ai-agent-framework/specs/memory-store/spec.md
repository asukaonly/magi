# Memory Store Spec

## ADDED Requirements

### Requirement: 记忆存储支持五层架构

系统SHALL实现五层事件记忆架构：
1. L1: 原始事件层（unstructured raw events）
2. L2: 事件关系层（event relationships graph）
3. L3: 事件语义层（vector embeddings）
4. L4: 摘要层（multi-time-granularity summaries）
5. L5: 能力记忆层（capability memory）

#### Scenario: 存储原始事件到L1
- **WHEN** 系统接收到新事件
- **THEN** 系统将原始事件以JSON格式存储到L1
- **AND** L1存储保留事件完整数据（时间戳、类型、数据、元数据）
- **AND** L1数据永不清除，作为事件溯源的基础

#### Scenario: 提取事件关系到L2
- **WHEN** 新事件添加到L1后
- **THEN** 系统自动提取事件之间的关系
- **AND** 使用混合提取策略（结构化事件用规则，非结构化事件用LLM）
- **AND** 存储到图数据库（如NetworkX）

#### Scenario: 生成向量嵌入到L3
- **WHEN** 事件语义内容需要被检索
- **THEN** 系统使用嵌入模型（如sentence-transformers）生成向量表示
- **AND** 存储到向量数据库（如ChromaDB）
- **AND** 支持语义相似度搜索

#### Scenario: 生成多粒度摘要到L4
- **WHEN** 系统积累一定数量的事件
- **THEN** 系统按时间粒度生成摘要（小时/天/周/月）
- **AND** 摘要存储到L4，支持快速查询历史趋势
- **AND** 摘要包含关键事件、统计数据、模式识别结果

#### Scenario: 提取能力到L5
- **WHEN** 系统成功完成某个任务或学会某个技能
- **THEN** 系统提取可复用的能力到L5
- **AND** L5存储能力定义、使用条件、成功案例、失败教训

---

### Requirement: 记忆存储支持自适应用户画像更新

系统SHALL使用退避算法自适应地更新用户画像，避免频繁更新造成资源浪费。

#### Scenario: 初始频繁更新阶段
- **WHEN** 系统处于初始运行阶段（前100次交互）
- **THEN** 每次交互后更新用户画像
- **AND** 更新频率为每次交互

#### Scenario: 稳定后退避更新阶段
- **WHEN** 系统完成初始阶段
- **THEN** 逐步降低更新频率
- **AND** 使用退避算法：1次 → 5次 → 10次 → 50次 → 每周
- **AND** 达到每周更新频率后保持稳定

#### Scenario: 重要变化触发立即更新
- **WHEN** 检测到用户行为显著变化（如新兴趣、新需求）
- **THEN** 立即更新用户画像
- **AND** 重置退避计数器

---

### Requirement: 记忆存储支持混合关系提取

系统SHALL使用混合策略提取事件关系：结构化事件使用规则，非结构化事件使用LLM。

#### Scenario: 结构化事件关系提取
- **WHEN** 事件类型为结构化（如AgentStarted、AgentStopped）
- **THEN** 使用预定义规则提取关系
- **AND** 规则定义父子关系、时序关系、因果关系
- **AND** 关系提取延迟 < 10ms

#### Scenario: 非结构化事件关系提取
- **WHEN** 事件类型为非结构化（如用户自然语言输入）
- **THEN** 使用LLM提取关系
- **AND** LLM分析事件的语义内容
- **AND** 提取实体关系、情感关系、意图关系

#### Scenario: 关系存储到图数据库
- **WHEN** 事件关系提取完成
- **THEN** 存储到L2图数据库
- **AND** 关系包含：源事件、目标事件、关系类型、置信度
- **AND** 支持图遍历查询

---

### Requirement: 记忆存储支持向量语义检索

系统SHALL支持基于向量嵌入的语义检索，用于相似事件查找。

#### Scenario: 生成事件向量嵌入
- **WHEN** 事件包含文本内容
- **THEN** 使用嵌入模型生成向量表示
- **AND** 向量维度为768（sentence-transformers默认）
- **AND** 存储到L3向量数据库

#### Scenario: 语义相似度搜索
- **WHEN** 用户查询相关历史事件
- **THEN** 系统将查询转换为向量
- **AND** 在L3中执行向量相似度搜索
- **AND** 返回top-k最相似事件（默认k=10）

#### Scenario: 多模态嵌入支持
- **WHEN** 事件包含图像、音频等多模态数据
- **THEN** 系统使用对应模态的嵌入模型
- **AND** 支持跨模态语义检索

---

### Requirement: 记忆存储支持多时间粒度摘要

系统SHALL支持多时间粒度的事件摘要，用于快速回顾历史趋势。

#### Scenario: 小时级摘要
- **WHEN** 系统运行满1小时
- **THEN** 生成该小时的事件摘要
- **AND** 摘要包含：关键事件列表、事件类型分布、错误统计

#### Scenario: 天级摘要
- **WHEN** 系统运行满1天
- **THEN** 生成该天的事件摘要
- **AND** 摘要包含：任务完成率、能力使用统计、用户活跃度

#### Scenario: 周级和月级摘要
- **WHEN** 系统运行满1周或1月
- **THEN** 生成对应粒度的摘要
- **AND** 摘要包含：长期趋势、模式识别、改进建议

---

### Requirement: 记忆存储支持能力提取和复用

系统SHALL自动从成功经验中提取能力，并支持能力复用。

#### Scenario: 能力提取触发
- **WHEN** 系统成功完成某个任务3次以上
- **THEN** 系统尝试提取能力到L5
- **AND** 分析任务特征、使用工具、成功模式

#### Scenario: 能力定义存储
- **WHEN** 能力提取成功
- **THEN** 存储能力定义到L5
- **AND** 能力包含：名称、描述、适用条件、所需工具、成功案例

#### Scenario: 能力复用查询
- **WHEN** 系统遇到新任务
- **THEN** 在L5中查询相关能力
- **AND** 如果匹配，优先使用已有能力

---

### Requirement: 记忆存储支持事件溯源

系统SHALL支持完整的事件溯源，可重放任意时间窗口的事件。

#### Scenario: 查询原始事件
- **WHEN** 用户查询某个时间范围的事件
- **THEN** 系统从L1读取原始事件
- **AND** 按时间顺序返回完整事件数据

#### Scenario: 事件重放
- **WHEN** 用户需要重放历史事件
- **THEN** 系统从L1读取事件序列
- **AND** 按原始顺序重新发布到消息总线
- **AND** 支持加速重放（如10x速度）

#### Scenario: 事件溯源导出
- **WHEN** 用户需要导出事件数据
- **THEN** 系统支持导出为JSON、CSV格式
- **AND** 包含L1-L5的所有层级数据

---

### Requirement: 记忆存储支持数据清理和归档

系统SHALL支持数据清理和归档策略，避免无限增长。

#### Scenario: L1原始事件归档
- **WHEN** L1数据超过90天
- **THEN** 系统将旧事件归档到冷存储
- **AND** 压缩存储，减少空间占用

#### Scenario: L3向量嵌入清理
- **WHEN** L3向量数据超过30天
- **THEN** 系统清理旧向量数据
- **AND** 保留高频访问事件的向量

#### Scenario: L4摘要保留策略
- **WHEN** L4摘要数据超过1年
- **THEN** 系统保留月级和年级摘要
- **AND** 删除小时级和天级摘要

---

### Requirement: 记忆存储支持并发访问

系统SHALL支持多Agent并发访问记忆存储，保证数据一致性。

#### Scenario: 多Agent并发写入
- **WHEN** 多个Agent同时写入事件
- **THEN** 系统使用乐观锁或悲观锁保证一致性
- **AND** 写入操作不阻塞读取

#### Scenario: 事务支持
- **WHEN** 操作涉及多个层级（如L1→L2→L3）
- **THEN** 系统支持原子事务
- **AND** 要么全部成功，要么全部回滚

---

## Acceptance Criteria

- [ ] 五层记忆架构完整实现并测试通过
- [ ] 自适应用户画像更新算法验证通过
- [ ] 混合关系提取策略验证通过
- [ ] 向量语义检索功能验证通过
- [ ] 多时间粒度摘要生成验证通过
- [ ] 能力提取和复用功能验证通过
- [ ] 事件溯源功能验证通过
- [ ] 数据清理和归档策略验证通过
- [ ] 并发访问一致性验证通过
